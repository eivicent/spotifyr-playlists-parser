---
title: "Artists Analysis"
description: "Top artists by month and total listening statistics"
---

```{r setup}
#| message: false
#| warning: false

# Load here first (needed to source utils file)
library(here)

# Load standardized utilities
source(here("src", "utils", "utils.R"))
load_common_libraries()
```

```{r load-artist-data}
#| message: false
#| warning: false

# Load artist data using standardized function
all_artist_data <- load_artist_data()
```

## Top 5 Artists - This Month, Last Month, and Historical

```{r top-artists-combined}
#| message: false

# Get current month and last month
current_month <- floor_date(Sys.Date(), "month")
last_month <- current_month - months(1)

# Filter data for current month
current_month_data <- all_artist_data %>%
  filter(year_month == current_month)

# Filter data for last month
last_month_data <- all_artist_data %>%
  filter(year_month == last_month)

# Calculate top 5 artists by days played for current month
top_5_current_month <- current_month_data %>%
  select(name, date) %>% unique() %>% 
  count(name, sort = TRUE) %>%
  head(5) %>%
  mutate(rank = row_number()) %>%
  select(rank, artist = name, plays = n) %>%
  mutate(combined = paste0(artist, "\n(", plays, " days)"))

# Calculate top 5 artists by days played for last month
top_5_last_month <- last_month_data %>%
  select(name, date) %>% unique() %>% 
  count(name, sort = TRUE) %>%
  head(5) %>%
  mutate(rank = row_number()) %>%
  select(rank, artist = name, plays = n) %>%
  mutate(combined = paste0(artist, "\n(", plays, " days)"))

# Calculate top 5 artists by days played historically (all time)
top_5_historical <- all_artist_data %>%
  select(name, date) %>% unique() %>% 
  count(name, sort = TRUE) %>%
  head(5) %>%
  mutate(rank = row_number()) %>%
  select(rank, artist = name, plays = n) %>%
  mutate(combined = paste0(artist, "\n(", plays, " days)"))

# Combine all three into one table
combined_table <- data.frame(
  Rank = 1:5,
  `This Month` = top_5_current_month$combined[match(1:5, top_5_current_month$rank)],
  `Last Month` = top_5_last_month$combined[match(1:5, top_5_last_month$rank)],
  `Historical` = top_5_historical$combined[match(1:5, top_5_historical$rank)],
  check.names = FALSE
)

# Replace NA with "-" for missing ranks
combined_table[is.na(combined_table)] <- "-"

# Display combined table
combined_table %>%
  gt() %>%
  tab_header(
    title = "Top 5 Artists Comparison",
    subtitle = paste("This Month:", format(current_month, "%B %Y"), "| Last Month:", format(last_month, "%B %Y"), "| Historical: All Time")
  ) %>%
  cols_label(
    Rank = "Rank",
    `This Month` = paste("This Month", format(current_month, "(%B %Y)")),
    `Last Month` = paste("Last Month", format(last_month, "(%B %Y)")),
    `Historical` = "Historical (All Time)"
  ) %>%
  opt_interactive(use_search = FALSE)
```

## Top 5 Artists by Total Songs and Days Listened

```{r top-artists-pivoted}
#| message: false

# Calculate top 5 artists by total number of songs listened
top_5_total_songs <- all_artist_data %>%
  count(name, sort = TRUE) %>%
  head(5) %>%
  mutate(rank = row_number()) %>%
  select(rank, artist = name, total_songs = n)

# Calculate top 5 artists by total different days listened
top_5_total_days <- all_artist_data %>%
  select(name, date) %>%
  distinct() %>%
  count(name, sort = TRUE) %>%
  head(5) %>%
  mutate(rank = row_number()) %>%
  select(rank, artist = name, total_days = n)

# Helper function to safely get artist info or "-"
get_artist_info <- function(artist_df, rank_num) {
  if (nrow(artist_df) >= rank_num && !is.na(artist_df$artist[rank_num])) {
    if ("total_songs" %in% names(artist_df)) {
      return(paste0(artist_df$artist[rank_num], " (", artist_df$total_songs[rank_num], ")"))
    } else {
      return(paste0(artist_df$artist[rank_num], " (", artist_df$total_days[rank_num], ")"))
    }
  } else {
    return("-")
  }
}

# Create pivoted table with metrics as rows and ranks as columns
pivoted_table <- data.frame(
  Metric = c("Total Songs", "Total Days"),
  `Rank 1` = c(
    get_artist_info(top_5_total_songs, 1),
    get_artist_info(top_5_total_days, 1)
  ),
  `Rank 2` = c(
    get_artist_info(top_5_total_songs, 2),
    get_artist_info(top_5_total_days, 2)
  ),
  `Rank 3` = c(
    get_artist_info(top_5_total_songs, 3),
    get_artist_info(top_5_total_days, 3)
  ),
  `Rank 4` = c(
    get_artist_info(top_5_total_songs, 4),
    get_artist_info(top_5_total_days, 4)
  ),
  `Rank 5` = c(
    get_artist_info(top_5_total_songs, 5),
    get_artist_info(top_5_total_days, 5)
  ),
  check.names = FALSE
)

# Display pivoted table
pivoted_table %>%
  gt() %>%
  tab_header(
    title = "Top 5 Artists by Total Songs and Days Listened",
    subtitle = "Metrics as rows, top 5 artists as columns (Artist Name (KPI))"
  ) %>%
  cols_label(
    Metric = "Metric"
  ) %>%
  opt_interactive(use_search = FALSE)
```

---

*Last updated on `r Sys.Date()`*

